<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementing a Microservice with Plumber • Use Microservices in R</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Implementing a Microservice with Plumber">
<meta property="og:description" content="microservices">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">Use Microservices in R</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/articles/microservices.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tidylab/microservices/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="02-plumber_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Implementing a Microservice with Plumber</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidylab/microservices/blob/master/vignettes/articles/02-plumber.Rmd"><code>vignettes/articles/02-plumber.Rmd</code></a></small>
      <div class="hidden name"><code>02-plumber.Rmd</code></div>

    </div>

    
    
<div id="running-microservices-with-plumber-api" class="section level2">
<h2 class="hasAnchor">
<a href="#running-microservices-with-plumber-api" class="anchor"></a>Running Microservices with <strong>plumber</strong> API</h2>
<div id="the-elements-of-plumber" class="section level3">
<h3 class="hasAnchor">
<a href="#the-elements-of-plumber" class="anchor"></a>The Elements of <strong>plumber</strong>
</h3>
<ol style="list-style-type: decimal">
<li><a href="#foreground-and-background-servers">Foreground and Background Servers</a></li>
<li>Endpoint</li>
<li>R Functions</li>
</ol>
</div>
<div id="foreground-and-background-servers" class="section level3">
<h3 class="hasAnchor">
<a href="#foreground-and-background-servers" class="anchor"></a>Foreground and Background Servers</h3>
<p>This package comes with working out-of-the-box <strong>plumber</strong> microservice. There are two options to spin-up the service:</p>
<ol style="list-style-type: decimal">
<li>
<code>entrypoints/plumber-foreground.R</code> runs at the foreground; and</li>
<li>
<code>entrypoints/plumber-background.R</code> runs at the background.</li>
</ol>
<p>Originally <strong>plumber</strong> runs in the foreground. That means the microservice locks down the session from running CLI commands or scripts. While this configuration is fine during deployment, on a dedicated server, it severely impedes development. We circumvent that hindrance by sourcing the microservice as a local job in RStudio.</p>
</div>
<div id="dissecting-the-plumber-entrypoint" class="section level3">
<h3 class="hasAnchor">
<a href="#dissecting-the-plumber-entrypoint" class="anchor"></a>Dissecting the plumber Entrypoint</h3>
<p>The commands to run the demo microservice with a <strong>plumber</strong> API in the foreground are:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">################################################################################</span>
<span class="co">## plumber: Quick Start Guide</span>
<span class="co">## &lt;https://www.rplumber.io/index.html&gt;</span>
<span class="co">################################################################################</span>
<span class="va">endpoint_path</span> <span class="op">&lt;-</span> <span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/proj_utils.html">proj_path</a></span><span class="op">(</span><span class="st">'inst'</span>, <span class="st">'endpoints'</span><span class="op">)</span>
<span class="va">config_path</span> <span class="op">&lt;-</span> <span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/proj_utils.html">proj_path</a></span><span class="op">(</span><span class="st">'inst'</span>, <span class="st">'configurations'</span>, <span class="st">'plumber.yml'</span><span class="op">)</span>
<span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">config</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/config/man/get.html">get</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">config_path</span><span class="op">)</span>

<span class="va">root</span> <span class="op">&lt;-</span> <span class="fu">plumber</span><span class="fu">::</span><span class="fu"><a href="https://www.rplumber.io/reference/pr.html">pr</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">root</span><span class="op">$</span><span class="fu">mount</span><span class="op">(</span><span class="st">'utility'</span>, <span class="fu">plumber</span><span class="fu">::</span><span class="va"><a href="https://www.rplumber.io/reference/Plumber.html">Plumber</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">endpoint_path</span>, <span class="st">'plumber-utility.R'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">root</span><span class="op">$</span><span class="fu">mount</span><span class="op">(</span><span class="st">'route_name'</span>, <span class="fu">plumber</span><span class="fu">::</span><span class="va"><a href="https://www.rplumber.io/reference/Plumber.html">Plumber</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">endpoint_path</span>, <span class="st">'plumber-{route_name}.R'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">root</span><span class="op">$</span><span class="fu">setDocsCallback</span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>
<span class="va">root</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>host <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">host</span>, port <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">port</span><span class="op">)</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>
<code>plumber::Plumber$new</code> creates a new Plumber router object. It requires a path to an endpoint file, which we discuss later in this document.</li>
<li>
<code>plumber$setDocsCallback</code> by default plumber opens a browser with <a href="https://swagger.io/specification/">OpenAPI Specification</a>. OpenAPI tells the microservice users what URI exists, what are their parameters. In addition, OpenAPI allows users to fiddle around with API requests directly from through its GUI. While OpenAPI is highly useful, it fails when launching the microservice in the background. Instead, we nullify the callback function , and the user can manually browse the visual documentation at <a href="http://127.0.0.1:8080/__docs__/" class="uri">http://127.0.0.1:8080/__docs__/</a>.</li>
<li>
<code>plumber$run</code> spins up the microservice at the given <code>host</code> and <code>port</code>.</li>
</ol>
<p>As a design choice, we store the service configuration on a yaml file and load it to the global environment before calling <code>plumber$run</code>. The configuration file is located in <code>config/r-config.yml</code> and its details are:</p>
</div>
<div id="dissecting-the-plumber-endpoint" class="section level3">
<h3 class="hasAnchor">
<a href="#dissecting-the-plumber-endpoint" class="anchor"></a>Dissecting the plumber Endpoint</h3>
<p>In the context of <strong>plumber</strong>, an endpoint is an R script with one or more functions that respond to particular requests. An example for such function can be found in the demo’s endpoint at <code>endpoints/plumber.R</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode e"><code class="sourceCode eiffel"><span id="cb2-1"><a href="#cb2-1"></a># Global code; gets executed at plumb() time.</span>
<span id="cb2-2"><a href="#cb2-2"></a>pkgload::load_all()</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a>#* Return input <span class="kw">class</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>#* Return the <span class="kw">class</span> of the input.</span>
<span id="cb2-6"><a href="#cb2-6"></a>#* @param x Any R data structure.</span>
<span id="cb2-7"><a href="#cb2-7"></a>#* @get utility/<span class="kw">class</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>function(x = NULL){</span>
<span id="cb2-9"><a href="#cb2-9"></a>    x &lt;- x %&gt;% jsonlite::fromJSON(flatten = TRUE)</span>
<span id="cb2-10"><a href="#cb2-10"></a>    demo$class_input(x)</span>
<span id="cb2-11"><a href="#cb2-11"></a>}</span></code></pre></div>
<p>In this example, there is a nameless function that will respond to GET requests at the URN <code>/utility/class</code>. Say if the microservice URL is <code>http://127.0.0.1:8080</code>, then the complete function address (URI) is <code>http://127.0.0.1:8080/utility/class</code>.</p>
<p>This endpoint excerpt emphasis two function are beyond the standard recommendations for <strong>plumber</strong>:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://rdrr.io/pkg/pkgload/man/load_all.html">pkgload::load_all()</a></code> makes the functions of the microservice (in the excerpt case its <code>demo$class_input</code>) available to the endpoint. Originally, <code><a href="https://rdrr.io/pkg/pkgload/man/load_all.html">pkgload::load_all()</a></code> is used for package development in R. Calling the function simulates the package under development as it were installed and loaded in R. In the excerpt case, <code>demo$class_input</code> lives under the “R” folder, and is loaded<br>
</li>
<li>
<code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::fromJSON</a></code> parses the received input into a familiar R object, such as a data.frame, list or some atomic data structure. Without this explicit call, the endpoint might misinterpret its input argument, a JSON string, as a character scalar.</li>
</ol>
<p>You can find more information about <strong>plumber</strong> endpoints at the <a href="https://www.rplumber.io/articles/routing-and-input.html">package’s website</a>.</p>
</div>
</div>
<div id="communicating-with-microservice" class="section level2">
<h2 class="hasAnchor">
<a href="#communicating-with-microservice" class="anchor"></a>Communicating with Microservice</h2>
<div id="inspecting-plumber-behaviour" class="section level3">
<h3 class="hasAnchor">
<a href="#inspecting-plumber-behaviour" class="anchor"></a>Inspecting <strong>plumber</strong> Behaviour</h3>
<p>This demo include three utility URIs:</p>
<ol style="list-style-type: decimal">
<li>
<code>127.0.0.1:8080/utility/healthcheck</code> returns status 200 if server is live and responding.</li>
<li>
<code>127.0.0.1:8080/utility/class</code> returns the class of the object sent to the server. This is useful to validate a JSON string is parsed as expected on the microservice.</li>
<li>
<code>127.0.0.1:8080/utility/mirror</code> returns the object that was sent to the server. This is useful to scrutinise the returning object from the microservice.</li>
</ol>
</div>
<div id="sending-and-receiving-json" class="section level3">
<h3 class="hasAnchor">
<a href="#sending-and-receiving-json" class="anchor"></a>Sending and Receiving JSON</h3>
<p>Send an object from R to the microservice with <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::toJSON</a></code>. For example, sending mtcars to <code>utility/mirror</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">input</span> <span class="op">&lt;-</span> <span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">input</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/URLencode.html">URLencode</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"http://localhost:808/utility/mirror?x="</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></code></pre></div>
<p>Parse an object returning from the microservice with <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::fromJSON</a></code>, For example, parsing the mtcars returning from <code>utility/mirror</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">output</span> <span class="op">&lt;-</span>
  <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/tidylab">Harel Lustiger</a>, <a href="https://github.com/tidylab"><img src="https://github.com/tidylab/tidylab/blob/master/favicon/apple-touch-icon-120x120.png?raw=true" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '474d70ad981ec9e952f0fdf673216b13',
    indexName: 'microservices',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
